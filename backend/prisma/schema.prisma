// CloudCare Prisma Schema
// Cross-checked with Android app models

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== User Authentication ====================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  patient  Patient?
  doctor   Doctor?
  hospital Hospital?

  @@map("users")
}

enum UserRole {
  PATIENT
  DOCTOR
  HOSPITAL_ADMIN
  SYSTEM_ADMIN

  @@map("user_role")
}

// ==================== Patient Models ====================

model Patient {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  aadharUid         String   @unique @map("aadhar_uid") // Derived from Aadhar
  name              String
  age               Int
  gender            String
  bloodType         String   @map("blood_type")
  contact           String
  email             String
  address           String
  familyContact     String   @map("family_contact")
  insuranceProvider String?  @map("insurance_provider")
  insuranceId       String?  @map("insurance_id")
  emergency         Boolean  @default(false)
  occupation        String?
  aiAnalysis        String?  @map("ai_analysis")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  medicalRecords     MedicalRecord[]
  activities         Activity[]
  consents           Consent[]
  wearableDevices    WearableDevice[]
  documentRequests   DocumentRequest[]
  emergencyAlerts    EmergencyAlert[]
  appointments       Appointment[]
  assignedToDoctors  DoctorPatient[]
  emergencyCases     EmergencyCase[]

  @@map("patients")
}

// ==================== Doctor Models ====================

model Doctor {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  name           String
  specialization String
  email          String
  phone          String
  department     String
  joinDate       DateTime @map("join_date")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  hospital          Hospital?           @relation(fields: [hospitalId], references: [id])
  hospitalId        String?             @map("hospital_id")
  assignedPatients  DoctorPatient[]
  appointments      Appointment[]
  patientRecords    PatientRecord[]
  emergencyCases    EmergencyCase[]

  @@map("doctors")
}

model DoctorPatient {
  id              String        @id @default(uuid())
  doctorId        String        @map("doctor_id")
  patientId       String        @map("patient_id")
  status          PatientStatus
  condition       String
  nextAppointment DateTime?     @map("next_appointment")
  lastVisit       DateTime?     @map("last_visit")
  emergencyFlag   Boolean       @default(false) @map("emergency_flag")
  assignedAt      DateTime      @default(now()) @map("assigned_at")

  // Relations
  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([doctorId, patientId])
  @@map("doctor_patients")
}

enum PatientStatus {
  STABLE
  MONITORING
  CRITICAL

  @@map("patient_status")
}

model Appointment {
  id          String            @id @default(uuid())
  patientId   String            @map("patient_id")
  doctorId    String            @map("doctor_id")
  hospitalId  String?           @map("hospital_id")
  date        DateTime
  time        String
  type        String
  department  String
  reason      String
  status      AppointmentStatus
  notes       String?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor   Doctor    @relation(fields: [doctorId], references: [id])
  hospital Hospital? @relation(fields: [hospitalId], references: [id])

  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  IN_PROGRESS

  @@map("appointment_status")
}

model PatientRecord {
  id            String           @id @default(uuid())
  patientId     String           @map("patient_id")
  doctorId      String           @map("doctor_id")
  recordType    DoctorRecordType @map("record_type")
  title         String
  date          DateTime
  description   String
  diagnosis     String?
  prescriptions String?
  doctorNotes   String?          @map("doctor_notes")
  testResults   String?          @map("test_results")
  createdAt     DateTime         @default(now()) @map("created_at")

  // Relations
  doctor Doctor @relation(fields: [doctorId], references: [id])

  @@map("patient_records")
}

enum DoctorRecordType {
  CHECKUP
  LAB_RESULT
  PRESCRIPTION
  DIAGNOSIS
  SURGERY
  EMERGENCY

  @@map("doctor_record_type")
}

// ==================== Hospital Models ====================

model Hospital {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  name            String
  address         String
  phone           String
  email           String
  totalBeds       Int      @map("total_beds")
  availableBeds   Int      @map("available_beds")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctors          Doctor[]
  departments      Department[]
  resources        HospitalResource[]
  emergencyCases   EmergencyCase[]
  facilities       Facility[]
  appointments     Appointment[]

  @@map("hospitals")
}

model Department {
  id           String           @id @default(uuid())
  hospitalId   String           @map("hospital_id")
  name         String
  totalBeds    Int              @map("total_beds")
  occupiedBeds Int              @map("occupied_beds")
  headDoctor   String           @map("head_doctor")
  status       DepartmentStatus
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  @@map("departments")
}

enum DepartmentStatus {
  NORMAL
  BUSY
  CRITICAL

  @@map("department_status")
}

model HospitalResource {
  id         String           @id @default(uuid())
  hospitalId String           @map("hospital_id")
  name       String
  category   ResourceCategory
  total      Int
  available  Int
  inUse      Int              @map("in_use")
  status     ResourceStatus
  updatedAt  DateTime         @updatedAt @map("updated_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  @@map("hospital_resources")
}

enum ResourceCategory {
  BEDS
  EQUIPMENT
  SUPPLIES
  MEDICATION

  @@map("resource_category")
}

enum ResourceStatus {
  NORMAL
  LOW
  CRITICAL

  @@map("resource_status")
}

model EmergencyCase {
  id            String            @id @default(uuid())
  hospitalId    String            @map("hospital_id")
  patientId     String            @map("patient_id")
  doctorId      String?           @map("doctor_id")
  condition     String
  severity      EmergencySeverity
  status        EmergencyStatus
  admittedTime  DateTime          @map("admitted_time")
  department    String
  notes         String?
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  doctor   Doctor?  @relation(fields: [doctorId], references: [id])

  @@map("emergency_cases")
}

enum EmergencySeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW

  @@map("emergency_severity")
}

enum EmergencyStatus {
  IN_TREATMENT
  STABLE
  WAITING
  DISCHARGED

  @@map("emergency_status")
}

// ==================== Facility & Medical Records ====================

model Facility {
  id         String       @id @default(uuid())
  hospitalId String?      @map("hospital_id")
  name       String
  type       FacilityType
  address    String?
  phone      String?
  email      String?
  createdAt  DateTime     @default(now()) @map("created_at")

  // Relations
  hospital       Hospital?       @relation(fields: [hospitalId], references: [id])
  medicalRecords MedicalRecord[]

  @@map("facilities")
}

enum FacilityType {
  HOSPITAL
  CLINIC
  LAB
  PHARMACY

  @@map("facility_type")
}

model MedicalRecord {
  id           String     @id @default(uuid())
  patientId    String     @map("patient_id")
  facilityId   String?    @map("facility_id")
  title        String
  description  String
  date         DateTime
  recordType   RecordType @map("record_type")
  fileUrl      String?    @map("file_url")
  createdAt    DateTime   @default(now()) @map("created_at")

  // Relations
  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  facility Facility? @relation(fields: [facilityId], references: [id])

  @@map("medical_records")
}

enum RecordType {
  LAB_REPORT
  PRESCRIPTION
  GENERAL
  CONSULTATION
  IMAGING

  @@map("record_type")
}

// ==================== Wearable Devices ====================

model WearableDevice {
  id              String   @id @default(uuid())
  patientId       String   @map("patient_id")
  name            String
  type            String
  deviceId        String   @unique @map("device_id") // External device ID
  isConnected     Boolean  @default(false) @map("is_connected")
  batteryLevel    Int      @default(100) @map("battery_level")
  lastSyncTime    DateTime? @map("last_sync_time")
  dataPointsSynced Int     @default(0) @map("data_points_synced")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("wearable_devices")
}

model DevicePairing {
  id              String   @id @default(uuid())
  iosUserId       String   @map("ios_user_id") // iOS CloudSync app user ID
  iosDeviceId     String   @map("ios_device_id") // Apple device identifier
  androidUserId   String   @map("android_user_id") // Android user ID
  deviceName      String   @map("device_name")
  deviceType      String   @map("device_type")
  pairingCode     String   @map("pairing_code")
  pairedAt        DateTime @default(now()) @map("paired_at")
  isActive        Boolean  @default(true) @map("is_active")
  lastSyncAt      DateTime? @map("last_sync_at")
  totalMetrics    Int      @default(0) @map("total_metrics")

  @@unique([iosDeviceId, androidUserId])
  @@index([androidUserId])
  @@index([iosDeviceId])
  @@map("device_pairings")
}

// Note: Wearable data is stored in MongoDB for better performance

// ==================== Activities & Consents ====================

model Activity {
  id          String       @id @default(uuid())
  patientId   String?      @map("patient_id")
  title       String
  description String
  timestamp   DateTime
  type        ActivityType
  metadata    String?      // JSON string for additional data

  // Relations
  patient Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("activities")
}

enum ActivityType {
  RECORD_SHARED
  CONSENT_REQUEST
  DATA_SYNCED
  LAB_REPORT_UPLOADED
  APPOINTMENT_SCHEDULED
  GENERAL

  @@map("activity_type")
}

model Consent {
  id           String        @id @default(uuid())
  patientId    String        @map("patient_id")
  facilityName String        @map("facility_name")
  requestType  String        @map("request_type")
  description  String?
  status       ConsentStatus
  requestedAt  DateTime      @default(now()) @map("requested_at")
  respondedAt  DateTime?     @map("responded_at")
  expiresAt    DateTime?     @map("expires_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("consents")
}

enum ConsentStatus {
  PENDING
  APPROVED
  DENIED

  @@map("consent_status")
}

// ==================== Document Requests ====================

model DocumentRequest {
  id              String                @id @default(uuid())
  patientId       String                @map("patient_id")
  requestingFacility String             @map("requesting_facility")
  documentType    String                @map("document_type")
  description     String?
  status          DocumentRequestStatus
  requestedAt     DateTime              @default(now()) @map("requested_at")
  fulfilledAt     DateTime?             @map("fulfilled_at")
  documentUrl     String?               @map("document_url")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("document_requests")
}

enum DocumentRequestStatus {
  PENDING
  IN_PROGRESS
  FULFILLED
  REJECTED

  @@map("document_request_status")
}

// ==================== Emergency Alerts ====================

model EmergencyAlert {
  id           String        @id @default(uuid())
  patientId    String        @map("patient_id")
  severity     AlertSeverity
  alertType    AlertType     @map("alert_type")
  message      String
  currentValue String?       @map("current_value")
  timestamp    DateTime      @default(now())
  isResolved   Boolean       @default(false) @map("is_resolved")
  resolvedAt   DateTime?     @map("resolved_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("emergency_alerts")
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW

  @@map("alert_severity")
}

enum AlertType {
  HEART_RATE
  OXYGEN_LEVEL
  BLOOD_PRESSURE
  TEMPERATURE
  OTHER

  @@map("alert_type")
}

// ==================== Audit Logs ====================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String
  resource  String
  details   String?  // JSON string
  ipAddress String?  @map("ip_address")
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}
