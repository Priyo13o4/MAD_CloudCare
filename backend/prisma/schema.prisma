// CloudCare Prisma Schema
// Cross-checked with Android app models

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== User Authentication ====================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String
  role          UserRole
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  patient  Patient?
  doctor   Doctor?
  hospital Hospital?

  @@map("users")
}

enum UserRole {
  PATIENT
  DOCTOR
  HOSPITAL_ADMIN
  SYSTEM_ADMIN

  @@map("user_role")
}

// ==================== Patient Models ====================

model Patient {
  id                    String    @id @default(uuid())
  user_id               String    @unique
  
  // Aadhar-Based Universal ID
  aadhar_uid            String    @unique  // HMAC-SHA256 hash (64 chars)
  encrypted_aadhar      String    // AES-256 encrypted original Aadhar
  aadhar_verified       Boolean   @default(false)
  aadhar_verified_at    DateTime?
  
  // Personal Information
  first_name            String
  middle_name           String?
  last_name             String
  date_of_birth         DateTime
  gender                String
  blood_group           String?
  
  // Contact Information
  phone_primary         String
  phone_secondary       String?
  email                 String
  address_line1         String
  address_line2         String?
  city                  String
  state                 String
  postal_code           String
  country               String    @default("India")
  
  // Emergency Contact
  emergency_contact_name     String
  emergency_contact_phone    String
  emergency_contact_relation String
  
  // Medical Profile
  height_cm             Float?
  weight_kg             Float?
  allergies             String?   // JSON array as string
  chronic_conditions    String?   // JSON array as string
  current_medications   String?   // JSON array as string
  
  // Insurance Details
  insurance_provider    String?
  insurance_policy_no   String?
  insurance_valid_until DateTime?
  
  // Legacy fields
  occupation            String?
  ai_analysis           String?
  
  // System Metadata
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  last_profile_update   DateTime?

  // Relations
  user                  User                 @relation(fields: [user_id], references: [id], onDelete: Cascade)
  medical_records       MedicalRecord[]
  activities            Activity[]
  consents              Consent[]
  wearable_devices      WearableDevice[]
  document_requests     DocumentRequest[]
  emergency_alerts      EmergencyAlert[]
  appointments          Appointment[]
  assigned_to_doctors   DoctorPatient[]
  emergency_cases       EmergencyCase[]

  @@index([aadhar_uid])
  @@index([phone_primary])
  @@map("patients")
}

// ==================== Doctor Models ====================

model Doctor {
  id                    String    @id @default(uuid())
  user_id               String    @unique
  
  // Professional Identification
  medical_license_no    String    @unique  // Medical Council registration
  registration_year     Int?
  registration_state    String?
  
  // Personal Information
  first_name            String
  middle_name           String?
  last_name             String
  title                 String    @default("Dr.")  // Dr., Prof. Dr., etc.
  date_of_birth         DateTime?
  gender                String?
  
  // Contact Information
  phone_primary         String
  phone_secondary       String?
  email_professional    String?
  address_line1         String?
  address_line2         String?
  city                  String?
  state                 String?
  postal_code           String?
  country               String    @default("India")
  
  // Professional Details
  specialization        String    // Cardiology, Neurology, etc. (can be comma-separated for multiple)
  sub_specialization    String?
  qualifications        String?   // JSON array as string: ["MBBS", "MD", "DM"]
  experience_years      Int       @default(0)
  languages_spoken      String?   // JSON array as string
  
  // Practice Information
  consultation_fee      Float?
  available_for_emergency Boolean @default(false)
  telemedicine_enabled    Boolean @default(false)
  
  // Hospital Linking (via hospital code during signup)
  hospital_code_input   String?   // Code entered during signup to link
  
  // Legacy fields
  department            String?
  join_date             DateTime?
  
  // Verification Status
  is_verified           Boolean   @default(false)
  verified_at           DateTime?
  is_active             Boolean   @default(true)
  
  // System Metadata
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  last_profile_update   DateTime?

  // Relations
  user                  User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  hospital              Hospital?           @relation("PrimaryHospital", fields: [hospital_id], references: [id])
  hospital_id           String?
  hospitals             DoctorHospital[]
  assigned_patients     DoctorPatient[]
  appointments          Appointment[]
  patient_records       PatientRecord[]
  emergency_cases       EmergencyCase[]

  @@index([medical_license_no])
  @@index([specialization])
  @@index([phone_primary])
  @@map("doctors")
}

// Many-to-Many relation between Doctors and Hospitals
model DoctorHospital {
  id          String   @id @default(uuid())
  doctor_id   String
  hospital_id String
  is_primary  Boolean  @default(false)
  joined_at   DateTime @default(now())
  
  // Relations
  doctor   Doctor   @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  hospital Hospital @relation(fields: [hospital_id], references: [id], onDelete: Cascade)
  
  @@unique([doctor_id, hospital_id])
  @@index([doctor_id])
  @@index([hospital_id])
  @@map("doctor_hospitals")
}

model DoctorPatient {
  id                String        @id @default(uuid())
  doctor_id         String
  patient_id        String
  status            PatientStatus
  condition         String
  next_appointment  DateTime?
  last_visit        DateTime?
  emergency_flag    Boolean       @default(false)
  assigned_at       DateTime      @default(now())

  // Relations
  doctor  Doctor  @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@unique([doctor_id, patient_id])
  @@map("doctor_patients")
}

enum PatientStatus {
  STABLE
  MONITORING
  CRITICAL
  LOCKED
  ACTIVE

  @@map("patient_status")
}

model Appointment {
  id          String            @id @default(uuid())
  patient_id  String
  doctor_id   String
  hospital_id String?
  date        DateTime
  time        String
  type        String
  department  String
  reason      String
  status      AppointmentStatus
  notes       String?
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt

  // Relations
  patient  Patient   @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  doctor   Doctor    @relation(fields: [doctor_id], references: [id])
  hospital Hospital? @relation(fields: [hospital_id], references: [id])

  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  IN_PROGRESS

  @@map("appointment_status")
}

model PatientRecord {
  id            String           @id @default(uuid())
  patient_id    String
  doctor_id     String
  record_type   DoctorRecordType
  title         String
  date          DateTime
  description   String
  diagnosis     String?
  prescriptions String?
  doctor_notes  String?
  test_results  String?
  created_at    DateTime         @default(now())

  // Relations
  doctor Doctor @relation(fields: [doctor_id], references: [id])

  @@map("patient_records")
}

enum DoctorRecordType {
  CHECKUP
  LAB_RESULT
  PRESCRIPTION
  DIAGNOSIS
  SURGERY
  EMERGENCY

  @@map("doctor_record_type")
}

// ==================== Hospital Models ====================

model Hospital {
  id                    String    @id @default(uuid())
  user_id               String    @unique
  
  // Facility Identification
  name                  String
  registration_no       String?   @unique  // Government registration
  license_no            String?   @unique  // Healthcare license
  accreditation         String?   // NABH, JCI, etc.
  hospital_code         String    @unique  // Auto-generated unique code (HC-XXXXXX)
  
  // Facility Type
  facility_type         String?   // MULTI_SPECIALTY_HOSPITAL, CLINIC, etc.
  specializations       String?   // JSON array as string
  
  // Contact Information
  phone_primary         String
  phone_emergency       String?
  email                 String
  website               String?
  
  // Address
  address_line1         String
  address_line2         String?
  city                  String
  state                 String
  postal_code           String
  country               String    @default("India")
  latitude              Float?
  longitude             Float?
  
  // Capacity
  total_beds            Int       @default(0)
  available_beds        Int       @default(0)
  icu_beds              Int       @default(0)
  emergency_beds        Int       @default(0)
  operation_theatres    Int       @default(0)
  
  // New Resources
  oxygen_cylinders      Int       @default(0)
  ventilators           Int       @default(0)
  ambulances            Int       @default(0)
  blood_bags            Int       @default(0) // Total units
  
  // Services
  has_emergency         Boolean   @default(true)
  has_ambulance         Boolean   @default(false)
  has_pharmacy          Boolean   @default(false)
  has_lab               Boolean   @default(false)
  has_blood_bank        Boolean   @default(false)
  telemedicine_enabled  Boolean   @default(false)
  
  // System Metadata
  is_active             Boolean   @default(true)
  is_verified           Boolean   @default(false)
  verified_at           DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  // Relations
  user                  User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  doctors               Doctor[]          @relation("PrimaryHospital")
  doctor_associations   DoctorHospital[]
  departments           Department[]
  resources             HospitalResource[]
  emergency_cases       EmergencyCase[]
  facilities            Facility[]
  appointments          Appointment[]

  @@index([city, state])
  @@index([facility_type])
  @@index([is_active, is_verified])
  @@map("hospitals")
}

model Department {
  id            String           @id @default(uuid())
  hospital_id   String
  name          String
  total_beds    Int
  occupied_beds Int
  head_doctor   String
  status        DepartmentStatus
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  // Relations
  hospital Hospital @relation(fields: [hospital_id], references: [id], onDelete: Cascade)

  @@map("departments")
}

enum DepartmentStatus {
  NORMAL
  BUSY
  CRITICAL

  @@map("department_status")
}

model HospitalResource {
  id          String           @id @default(uuid())
  hospital_id String
  name        String
  category    ResourceCategory
  total       Int
  available   Int
  in_use      Int
  status      ResourceStatus
  updated_at  DateTime         @updatedAt

  // Relations
  hospital Hospital @relation(fields: [hospital_id], references: [id], onDelete: Cascade)

  @@map("hospital_resources")
}

enum ResourceCategory {
  BEDS
  EQUIPMENT
  SUPPLIES
  MEDICATION

  @@map("resource_category")
}

enum ResourceStatus {
  NORMAL
  LOW
  CRITICAL

  @@map("resource_status")
}

model EmergencyCase {
  id            String            @id @default(uuid())
  hospital_id   String
  patient_id    String
  doctor_id     String?
  condition     String
  severity      EmergencySeverity
  status        EmergencyStatus
  admitted_time DateTime
  department    String
  notes         String?
  created_at    DateTime          @default(now())
  updated_at    DateTime          @updatedAt

  // Relations
  hospital Hospital @relation(fields: [hospital_id], references: [id])
  patient  Patient  @relation(fields: [patient_id], references: [id])
  doctor   Doctor?  @relation(fields: [doctor_id], references: [id])

  @@map("emergency_cases")
}

enum EmergencySeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW

  @@map("emergency_severity")
}

enum EmergencyStatus {
  IN_TREATMENT
  STABLE
  WAITING
  DISCHARGED

  @@map("emergency_status")
}

// ==================== Facility & Medical Records ====================

model Facility {
  id          String       @id @default(uuid())
  hospital_id String?
  name        String
  type        FacilityType
  address     String?
  phone       String?
  email       String?
  created_at  DateTime     @default(now())

  // Relations
  hospital       Hospital?       @relation(fields: [hospital_id], references: [id])
  medical_records MedicalRecord[]

  @@map("facilities")
}

enum FacilityType {
  HOSPITAL
  CLINIC
  LAB
  PHARMACY

  @@map("facility_type")
}

model MedicalRecord {
  id          String     @id @default(uuid())
  patient_id  String
  facility_id String?
  title       String
  description String
  date        DateTime
  record_type RecordType
  file_url    String?
  created_at  DateTime   @default(now())

  // Relations
  patient  Patient   @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  facility Facility? @relation(fields: [facility_id], references: [id])

  @@map("medical_records")
}

enum RecordType {
  LAB_REPORT
  PRESCRIPTION
  GENERAL
  CONSULTATION
  IMAGING

  @@map("record_type")
}

// ==================== Wearable Devices ====================

model WearableDevice {
  id                 String    @id @default(uuid())
  patient_id         String
  name               String
  type               String
  device_id          String    @unique // External device ID
  is_connected       Boolean   @default(false)
  battery_level      Int       @default(100)
  last_sync_time     DateTime?
  data_points_synced Int       @default(0)
  source_version     String?   // Apple HealthKit source version (moved from MongoDB metadata)
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  // Relations
  patient Patient @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@map("wearable_devices")
}

model DevicePairing {
  id              String    @id @default(uuid())
  ios_user_id     String    // iOS CloudSync app user ID
  ios_device_id   String    // Apple device identifier
  android_user_id String    // Android user ID
  device_name     String
  device_type     String
  pairing_code    String
  paired_at       DateTime  @default(now())
  is_active       Boolean   @default(true)
  last_sync_at    DateTime?
  total_metrics   Int       @default(0)

  @@unique([ios_device_id, android_user_id])
  @@index([android_user_id])
  @@index([ios_device_id])
  @@map("device_pairings")
}

// Note: Wearable data is stored in MongoDB for better performance

// ==================== Activities & Consents ====================

model Activity {
  id          String       @id @default(uuid())
  patient_id  String?
  title       String
  description String
  timestamp   DateTime
  type        ActivityType
  metadata    String?      // JSON string for additional data

  // Relations
  patient Patient? @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@map("activities")
}

enum ActivityType {
  RECORD_SHARED
  CONSENT_REQUEST
  DATA_SYNCED
  LAB_REPORT_UPLOADED
  APPOINTMENT_SCHEDULED
  GENERAL

  @@map("activity_type")
}

model Consent {
  id              String        @id @default(uuid())
  patient_id      String
  facility_name   String
  request_type    String
  description     String?
  status          ConsentStatus
  requested_at    DateTime      @default(now())
  responded_at    DateTime?
  expires_at      DateTime?

  // Relations
  patient Patient @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@map("consents")
}

enum ConsentStatus {
  PENDING
  APPROVED
  DENIED
  REVOKED

  @@map("consent_status")
}

// ==================== Document Requests ====================

model DocumentRequest {
  id                  String                @id @default(uuid())
  patient_id          String
  requesting_facility String
  document_type       String
  description         String?
  status              DocumentRequestStatus
  requested_at        DateTime              @default(now())
  fulfilled_at        DateTime?
  document_url        String?

  // Relations
  patient Patient @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@map("document_requests")
}

enum DocumentRequestStatus {
  PENDING
  IN_PROGRESS
  FULFILLED
  REJECTED

  @@map("document_request_status")
}

// ==================== Emergency Alerts ====================

model EmergencyAlert {
  id            String        @id @default(uuid())
  patient_id    String
  severity      AlertSeverity
  alert_type    AlertType
  message       String
  current_value String?
  timestamp     DateTime      @default(now())
  is_resolved   Boolean       @default(false)
  resolved_at   DateTime?

  // Relations
  patient Patient @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@map("emergency_alerts")
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW

  @@map("alert_severity")
}

enum AlertType {
  HEART_RATE
  OXYGEN_LEVEL
  BLOOD_PRESSURE
  TEMPERATURE
  OTHER

  @@map("alert_type")
}

// ==================== Audit Logs ====================

model AuditLog {
  id         String   @id @default(uuid())
  user_id    String
  action     String
  resource   String
  details    String?  // JSON string
  ip_address String?
  timestamp  DateTime @default(now())

  @@index([user_id])
  @@index([timestamp])
  @@map("audit_logs")
}
